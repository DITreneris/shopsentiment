{% extends "base.html" %}

{% block title %}ShopSentiment - Dashboard{% endblock %}

{% block additional_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-bs5@1.13.1/css/dataTables.bootstrap5.min.css">
{% endblock %}

{% block content %}
<div class="mb-4">
    <h2>Analysis Results</h2>
    <p>
        Platform: <span class="fw-bold">{{ product.platform }}</span> |
        Product ID: <span class="fw-bold">{{ product.product_id }}</span>
    </p>
</div>

<div class="row">
    <!-- Sentiment Distribution -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">Sentiment Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="sentimentChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Top Keywords -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">Top Keywords</h5>
            </div>
            <div class="card-body">
                <canvas id="keywordsChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Sentiment Over Time -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Sentiment Trend</h5>
            </div>
            <div class="card-body">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Reviews Table -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">All Reviews</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="reviewsTable" class="table table-striped">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Rating</th>
                                <th>Sentiment</th>
                                <th>Review</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for review in reviews %}
                            <tr>
                                <td>{{ review.date }}</td>
                                <td>{{ review.rating }}</td>
                                <td>
                                    {% if review.sentiment > 0.05 %}
                                        <span class="badge bg-success">Positive</span>
                                    {% elif review.sentiment < -0.05 %}
                                        <span class="badge bg-danger">Negative</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">Neutral</span>
                                    {% endif %}
                                </td>
                                <td>{{ review.text|truncate(100) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/datatables.net@1.13.1/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net-bs5@1.13.1/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Sentiment Distribution Chart
        const sentimentCtx = document.getElementById('sentimentChart').getContext('2d');
        const sentimentChart = new Chart(sentimentCtx, {
            type: 'pie',
            data: {
                labels: ['Positive', 'Neutral', 'Negative'],
                datasets: [{
                    data: [
                        {{ sentiment_counts.Positive }}, 
                        {{ sentiment_counts.Neutral }}, 
                        {{ sentiment_counts.Negative }}
                    ],
                    backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    title: {
                        display: true,
                        text: 'Review Sentiment'
                    }
                }
            }
        });
        
        // Keywords Chart
        const keywordsCtx = document.getElementById('keywordsChart').getContext('2d');
        const keywordsChart = new Chart(keywordsCtx, {
            type: 'bar',
            data: {
                labels: [
                    {% for keyword in keywords.keys() %}
                        "{{ keyword }}",
                    {% endfor %}
                ],
                datasets: [{
                    label: 'Frequency',
                    data: [
                        {% for count in keywords.values() %}
                            {{ count }},
                        {% endfor %}
                    ],
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        // Trend Chart (simplified - would be more sophisticated in production)
        const dates = [];
        const sentiments = [];
        {% for review in sentiment_by_date %}
            dates.push("{{ review.date }}");
            sentiments.push({{ review.sentiment }});
        {% endfor %}
        
        const trendCtx = document.getElementById('trendChart').getContext('2d');
        const trendChart = new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Sentiment Score',
                    data: sentiments,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    tension: 0.1,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        min: -1,
                        max: 1
                    }
                }
            }
        });
        
        // Initialize DataTable
        $(document).ready(function() {
            $('#reviewsTable').DataTable({
                order: [[0, 'desc']], // Sort by date, most recent first
                pageLength: 10,
                lengthMenu: [10, 25, 50, 100]
            });
        });
    });
</script>
{% endblock %} 